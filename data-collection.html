<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos de Registro de Inscripción de IGT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Importar Firebase SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tu configuración de Firebase (DEBE SER LA MISMA QUE EN auth.html)
        const firebaseConfig = {
            apiKey: "AIzaSyCQPZiekhX6LOitpyAy1pYUNb0Lb74k8WQ",
            authDomain: "instituto-gerencial-de-talento.firebaseapp.com",
            projectId: "instituto-gerencial-de-talento",
            storageBucket: "instituto-gerencial-de-talento.firebasestorage.app",
            messagingSenderId: "549000895234",
            appId: "1:549000895234:web:e3621a884d7078d350c01b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Ocultar mensajes de log de Firebase
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('error');

        let currentPhase = 1;
        const totalPhases = 3;
        // Eliminado: autoSaveTimeout, AUTOSAVE_DELAY

        // Elementos de navegación y fases
        const mainFormCard = document.getElementById('main-form-card');
        const phaseIndicator = document.getElementById('phase-indicator');
        const phase1Div = document.getElementById('phase-1');
        const phase2Div = document.getElementById('phase-2');
        const phase3Div = document.getElementById('phase-3');
        const prevButton = document.getElementById('prev-phase-btn');
        const nextButton = document.getElementById('next-phase-btn');
        const finishButton = document.getElementById('finish-registration-btn');
        const logoutButton = document.getElementById('logout-btn');

        // Campos de la Fase 1
        const firstNameDisplay = document.getElementById('first-name-display');
        const lastNameDisplay = document.getElementById('last-name-display');
        const emailDisplay = document.getElementById('email-display');
        const phonePrefixInput = document.getElementById('phone-prefix');
        const phoneNumberInput = document.getElementById('phone-number');
        const ciTypeInput = document.getElementById('ci-type');
        const ciNumberInput = document.getElementById('ci-number');
        const addressInput = document.getElementById('address');
        const dobInput = document.getElementById('dob');
        const ageDisplay = document.getElementById('age-display');
        const courseToApplyInput = document.getElementById('course-to-apply');
        const genderInput = document.getElementById('gender');

        // Campos de la Fase 2
        const educationStatusInput = document.getElementById('education-status');
        const studyShiftInput = document.getElementById('study-shift');
        const currentStudyLevelInput = document.getElementById('current-study-level');
        const institutionInput = document.getElementById('institution');
        const degreeInput = document.getElementById('degree');
        const graduationYearInput = document.getElementById('graduation-year');

        // Campos de la Fase 3 (inputs de tipo file son placeholders por ahora)
        const ciUploadInput = document.getElementById('ci-upload');
        const degreeUploadInput = document.getElementById('degree-upload');
        const otherDocsUploadInput = document.getElementById('other-docs-upload');
        const agreeTermsCheckbox = document.getElementById('agree-terms');


        // Funciones auxiliares
        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return '';
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age >= 0 ? age : '';
        }

        dobInput.addEventListener('change', () => {
            ageDisplay.textContent = calculateAge(dobInput.value);
            // Eliminado: triggerAutoSave();
        });

        // Lógica condicional para Turno de estudio
        educationStatusInput.addEventListener('change', () => {
            const status = educationStatusInput.value;
            const studyShiftContainer = document.getElementById('study-shift-container');
            if (status === 'Estudiando Liceo' || status === 'Estudiando Universidad') {
                studyShiftContainer.classList.remove('hidden');
                studyShiftInput.setAttribute('required', 'required');
            } else {
                studyShiftContainer.classList.add('hidden');
                studyShiftInput.removeAttribute('required');
                studyShiftInput.value = ''; // Limpiar si se oculta
            }
            // Eliminado: triggerAutoSave();
        });

        // Nueva función para guardar datos al cambiar de fase o finalizar
        async function saveFormDataOnPhaseChange() {
            const currentUser = auth.currentUser;
            if (!currentUser) return;

            console.log("Guardando datos al cambiar de fase...");
            const userProfileRef = doc(db, `artifacts/default-app-id/users/${currentUser.uid}/private_data/user_profile`);
            
            const dataToSave = {
                currentPhase: currentPhase,
                phone: `${phonePrefixInput.value}${phoneNumberInput.value}`,
                ciType: ciTypeInput.value,
                ciNumber: ciNumberInput.value,
                address: addressInput.value,
                dateOfBirth: dobInput.value,
                courseToApply: courseToApplyInput.value,
                gender: genderInput.value,
                
                educationStatus: educationStatusInput.value,
                studyShift: studyShiftInput.value,
                currentStudyLevel: currentStudyLevelInput.value,
                institution: institutionInput.value,
                degree: degreeInput.value,
                graduationYear: graduationYearInput.value ? parseInt(graduationYearInput.value) : null, 

                updatedAt: new Date()
            };

            try {
                await setDoc(userProfileRef, dataToSave, { merge: true });
                console.log("Datos guardados en Firestore.");
            } catch (error) {
                console.error("Error al guardar datos:", error);
            }
        }
        // Eliminado: Event listeners para autoguardado en todos los campos editables


        // Lógica de fases
        function updatePhaseIndicator() {
            const phaseElements = document.querySelectorAll('.phase-step');
            phaseElements.forEach((el, index) => {
                if (index < currentPhase - 1) {
                    el.classList.add('bg-blue-600', 'text-white');
                    el.classList.remove('bg-gray-700', 'text-gray-400');
                } else if (index === currentPhase - 1) {
                    el.classList.add('bg-blue-600', 'text-white');
                    el.classList.remove('bg-gray-700', 'text-gray-400');
                }
                else {
                    el.classList.add('bg-gray-700', 'text-gray-400');
                    el.classList.remove('bg-blue-600', 'text-white');
                }
            });
        }

        function showPhase(phaseNumber) {
            phase1Div.classList.add('hidden');
            phase2Div.classList.add('hidden');
            phase3Div.classList.add('hidden');

            switch (phaseNumber) {
                case 1:
                    phase1Div.classList.remove('hidden');
                    prevButton.classList.add('hidden');
                    nextButton.classList.remove('hidden');
                    finishButton.classList.add('hidden');
                    break;
                case 2:
                    phase2Div.classList.remove('hidden');
                    prevButton.classList.remove('hidden');
                    nextButton.classList.remove('hidden');
                    finishButton.classList.add('hidden');
                    break;
                case 3:
                    phase3Div.classList.remove('hidden');
                    prevButton.classList.remove('hidden');
                    nextButton.classList.add('hidden');
                    finishButton.classList.remove('hidden');
                    break;
            }
            currentPhase = phaseNumber;
            updatePhaseIndicator();
            if (mainFormCard) {
                mainFormCard.scrollTop = 0;
            }
        }

        function validateCurrentPhase() {
            let isValid = true;
            let fieldsToValidate = [];

            switch (currentPhase) {
                case 1:
                    fieldsToValidate = [
                        phonePrefixInput, phoneNumberInput, ciTypeInput, ciNumberInput, addressInput, dobInput, courseToApplyInput, genderInput
                    ];
                    break;
                case 2:
                    fieldsToValidate = [
                        educationStatusInput, currentStudyLevelInput, institutionInput, graduationYearInput
                    ];
                    const status = educationStatusInput.value;
                    if (status === 'Estudiando Liceo' || status === 'Estudiando Universidad') {
                        fieldsToValidate.push(studyShiftInput);
                    }
                    // degreeInput es opcional
                    break;
                case 3:
                    fieldsToValidate = [
                        agreeTermsCheckbox
                    ];
                    if (!agreeTermsCheckbox.checked) {
                        isValid = false;
                    }
                    break;
            }

            for (const field of fieldsToValidate) {
                if (field.type === 'file') {
                    continue; 
                }
                if (field.value.trim() === '' || (field.type === 'checkbox' && !field.checked)) {
                    field.classList.add('border-red-500', 'ring-red-500');
                    isValid = false;
                } else {
                    field.classList.remove('border-red-500', 'ring-red-500');
                }
            }

            if (!isValid) {
                alert("Por favor, completa todos los campos requeridos en esta fase.");
            }
            return isValid;
        }

        async function nextPhase() {
            // Eliminado: clearTimeout(autoSaveTimeout);
            
            if (validateCurrentPhase()) {
                await saveFormDataOnPhaseChange(); // Guardar antes de avanzar
                if (currentPhase < totalPhases) {
                    showPhase(currentPhase + 1);
                }
            }
        }

        async function prevPhase() {
            // Eliminado: clearTimeout(autoSaveTimeout);
            await saveFormDataOnPhaseChange(); // Guardar antes de retroceder
            
            if (currentPhase > 1) {
                showPhase(currentPhase - 1);
            }
        }

        prevButton.addEventListener('click', prevPhase);
        nextButton.addEventListener('click', nextPhase);
        
        // Listener para el estado de autenticación (ejecutado al cargar la página)
        onAuthStateChanged(auth, async (user) => {
            console.log("data-collection.html: onAuthStateChanged fired. User:", user ? user.email : "null", "Verified:", user ? user.emailVerified : "N/A");

            if (user && user.emailVerified) {
                const userProfileRef = doc(db, `artifacts/default-app-id/users/${user.uid}/private_data/user_profile`);
                const userProfileSnap = await getDoc(userProfileRef);
                const userProfileData = userProfileSnap.exists() ? userProfileSnap.data() : {};

                if (userProfileData.dataCollected === true) {
                    console.log("data-collection.html: Datos ya recolectados. Redirigiendo a dashboard.html.");
                    window.location.href = 'dashboard.html';
                    return;
                }

                currentPhase = userProfileData.currentPhase || 1;

                firstNameDisplay.textContent = userProfileData.firstName || 'N/A';
                lastNameDisplay.textContent = userProfileData.lastName || 'N/A';
                emailDisplay.textContent = user.email || 'N/A';
                
                // Cargar datos en los campos editables
                // Teléfono
                const fullPhone = userProfileData.phone || '';
                if (fullPhone.length >= 4) {
                    phonePrefixInput.value = fullPhone.substring(0, 4);
                    phoneNumberInput.value = fullPhone.substring(4);
                } else {
                    phonePrefixInput.value = ''; 
                    phoneNumberInput.value = fullPhone;
                }
                
                // Cédula de Identidad
                const ciNumber = userProfileData.ciNumber || '';
                const ciType = userProfileData.ciType || '';
                if (ciType && ciNumber) {
                    ciTypeInput.value = ciType;
                    ciNumberInput.value = ciNumber;
                } else if (userProfileData.ci) {
                    const oldCi = userProfileData.ci;
                     if (oldCi.startsWith('V') || oldCi.startsWith('E')) {
                        ciTypeInput.value = oldCi.substring(0,1);
                        ciNumberInput.value = oldCi.substring(1);
    
